name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: simplexml, openssl, json
          coverage: none

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run tests
        run: vendor/bin/pest --testdox

      - name: Determine next version
        id: version
        run: |
          # Son tag'i al
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # Versiyon parÃ§alarÄ±nÄ± ayÄ±r
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Son tag'den bu yana commit mesajlarÄ±nÄ± analiz et
          COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

          if [ -z "$COMMITS" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Versiyon artÄ±ÅŸÄ±nÄ± belirle
          BUMP="none"

          while IFS= read -r msg; do
            # BREAKING CHANGE kontrolÃ¼
            if echo "$msg" | grep -qE "^(feat|fix|refactor|perf|chore|docs|style|test|build|ci)(\(.+\))?!:" || \
               echo "$msg" | grep -q "BREAKING CHANGE"; then
              BUMP="major"
              break
            fi
            # feat â†’ minor
            if echo "$msg" | grep -qE "^feat(\(.+\))?:"; then
              if [ "$BUMP" != "major" ]; then
                BUMP="minor"
              fi
            fi
            # fix, perf, refactor â†’ patch
            if echo "$msg" | grep -qE "^(fix|perf|refactor)(\(.+\))?:"; then
              if [ "$BUMP" = "none" ]; then
                BUMP="patch"
              fi
            fi
          done <<< "$COMMITS"

          if [ "$BUMP" = "none" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Yeni versiyonu hesapla
          case $BUMP in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION ($BUMP)"

      - name: Generate changelog
        if: steps.version.outputs.skip != 'true'
        id: changelog
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          NEW_VERSION=${{ steps.version.outputs.new_version }}

          {
            echo "changelog<<CHANGELOG_EOF"

            # Commit'leri kategorize et
            if [ -n "$LATEST_TAG" ]; then
              RANGE="${LATEST_TAG}..HEAD"
            else
              RANGE="HEAD"
            fi

            # Features
            FEATS=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^feat" --extended-regexp 2>/dev/null)
            if [ -n "$FEATS" ]; then
              echo "### ðŸš€ Yeni Ã–zellikler"
              echo "$FEATS"
              echo ""
            fi

            # Fixes
            FIXES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^fix" --extended-regexp 2>/dev/null)
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Hata DÃ¼zeltmeleri"
              echo "$FIXES"
              echo ""
            fi

            # Performance
            PERFS=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^perf" --extended-regexp 2>/dev/null)
            if [ -n "$PERFS" ]; then
              echo "### âš¡ Performans Ä°yileÅŸtirmeleri"
              echo "$PERFS"
              echo ""
            fi

            # Refactors
            REFACTORS=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^refactor" --extended-regexp 2>/dev/null)
            if [ -n "$REFACTORS" ]; then
              echo "### â™»ï¸ Yeniden DÃ¼zenleme"
              echo "$REFACTORS"
              echo ""
            fi

            # Docs
            DOCS=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^docs" --extended-regexp 2>/dev/null)
            if [ -n "$DOCS" ]; then
              echo "### ðŸ“ DokÃ¼mantasyon"
              echo "$DOCS"
              echo ""
            fi

            # Chores & CI
            CHORES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^chore\|^ci\|^build" --extended-regexp 2>/dev/null)
            if [ -n "$CHORES" ]; then
              echo "### ðŸ”§ BakÄ±m"
              echo "$CHORES"
              echo ""
            fi

            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT

      - name: Update composer.json version
        if: steps.version.outputs.skip != 'true'
        run: |
          NEW_VERSION=${{ steps.version.outputs.new_version }}
          VERSION_NUM=${NEW_VERSION#v}
          # composer.json'daki versiyon alanÄ±nÄ± gÃ¼ncelle
          sed -i "s/\"version\": \".*\"/\"version\": \"${VERSION_NUM}\"/" composer.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add composer.json
          git commit -m "chore(release): bump version to ${NEW_VERSION} [skip ci]"
          git push

      - name: Create tag and release
        if: steps.version.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION=${{ steps.version.outputs.new_version }}
          git tag -a $NEW_VERSION -m "Release $NEW_VERSION"
          git push origin $NEW_VERSION

          gh release create $NEW_VERSION \
            --title "$NEW_VERSION" \
            --notes "${{ steps.changelog.outputs.changelog }}" \
            --latest
